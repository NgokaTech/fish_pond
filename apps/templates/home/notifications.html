{% extends "layouts/base.html" %}

{% block title %} Notifications Dashboard {% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-12 mx-auto">
            <div class="card mt-4 border-warning">
                <div class="card-header p-3 bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h4 class="card-title">Railway Inspection Notifications</h4>
                </div>
                <div class="card-body">
                    <div id="notifications-container" class="notification-container row">
                        <!-- Notifications will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #2c3e50;
        color: #ecf0f1;
    }
    .notification {
        background-color: #34495e;
        border: 1px solid #f39c12;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 5px;
        position: relative;
        z-index: 1;
        color: #ecf0f1;
    }
    .notification img {
        width: 100%;
        height: auto;
        cursor: pointer;
    }
    .notification.new::before {
        content: "NEW";
        color: white;
        background-color: #f1c40f;
        font-weight: bold;
        position: absolute;
        top: 10px;
        left: 10px;
        padding: 5px 10px;
        border-radius: 5px;
        z-index: 2;
    }
    .full-screen {
        display: none;
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        align-items: center;
        justify-content: center;
    }
    .full-screen img {
        max-width: 90%;
        max-height: 90%;
    }
    .card-header {
        background-color: #f39c12;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/notifications')
            .then(response => response.json())
            .then(data => {
                const notifications = data.alerts;
                const notificationsContainer = document.getElementById('notifications-container');
                notifications.forEach((notification, index) => {
                    const notificationDiv = document.createElement('div');
                    notificationDiv.classList.add('notification', 'card', 'mb-3', 'col-md-4', 'border-warning');
                    if (index < 5) {
                        notificationDiv.classList.add('new');
                    }

                    const cardBody = document.createElement('div');
                    cardBody.classList.add('card-body');

                    const defectType = document.createElement('h5');
                    defectType.className = 'card-title text-warning';
                    defectType.innerText = notification.defect_type;
                    cardBody.appendChild(defectType);

                    const description = document.createElement('p');
                    description.className = 'card-text';
                    description.innerText = notification.description;
                    cardBody.appendChild(description);

                    const geoLocation = document.createElement('p');
                    geoLocation.className = 'card-text';
                    geoLocation.innerText = `Geo Location: ${notification.geo_location}`;
                    cardBody.appendChild(geoLocation);

                    const timestamp = document.createElement('p');
                    timestamp.className = 'card-text text-muted';
                    timestamp.innerText = `Detected on: ${new Date(notification.detection_date).toLocaleString()}`;
                    cardBody.appendChild(timestamp);

                    if (notification.image) {
                        const img = document.createElement('img');
                        img.src = `data:image/jpeg;base64,${notification.image}`;
                        img.alt = notification.defect_type;
                        img.className = 'card-img-top mb-2';
                        cardBody.insertBefore(img, cardBody.firstChild);
                        img.addEventListener('click', () => showFullScreenImage(img));
                    }

                    notificationDiv.appendChild(cardBody);
                    notificationsContainer.appendChild(notificationDiv);
                });
            })
            .catch(error => console.error('Error fetching notifications:', error));
    });

    function showFullScreenImage(imgElement) {
        const fullScreenDiv = document.getElementById('fullScreen');
        const fullScreenImg = document.getElementById('fullScreenImg');
        fullScreenImg.src = imgElement.src;
        fullScreenDiv.style.display = 'flex';
        fullScreenDiv.addEventListener('click', function() {
            fullScreenDiv.style.display = 'none';
        });
    }
</script>
<div class="full-screen" id="fullScreen">
    <img id="fullScreenImg" src="" alt="Full Screen Image">
</div>
{% endblock content %}
