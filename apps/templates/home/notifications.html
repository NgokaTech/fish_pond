{% extends "layouts/base.html" %}

{% block title %} Notifications Dashboard {% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-12 mx-auto">
            <div class="card mt-4 border-success">
                <div class="card-header p-3 bg-success text-white">
                    <h4 class="card-title">Notifications Dashboard</h4>
                </div>
                <div class="card-body">
                    <div id="notifications-container" class="notification-container row">
                        <!-- Notifications will be inserted here -->
                    </div>
                    <div class="d-flex justify-content-between mt-4">
                        <button id="prev-page" class="btn btn-success" disabled>Previous</button>
                        <span id="page-info">Page 1</span>
                        <button id="next-page" class="btn btn-success">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const notificationsPerPage = 10; // Show 10 items per page
    let currentPage = 1;
    let notifications = [];

    // Function to fetch notifications and display them
    function loadNotifications() {
        fetch('/api/notifications')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                notifications = data.alerts;
                notifications.reverse(); // Reverse notifications to show latest first
                renderNotifications();
            })
            .catch(error => {
                console.error('Error fetching notifications:', error);
            });
    }

    // Function to render notifications for the current page
    function renderNotifications() {
        const container = document.getElementById('notifications-container');
        const pageInfo = document.getElementById('page-info');
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');

        container.innerHTML = ''; // Clear previous content

        const startIndex = (currentPage - 1) * notificationsPerPage;
        const endIndex = Math.min(startIndex + notificationsPerPage, notifications.length);
        const pageNotifications = notifications.slice(startIndex, endIndex);

        pageNotifications.forEach(alert => {
            // Create notification element
            const alertDiv = document.createElement('div');
            alertDiv.className = 'notification card mb-3 col-md-4 border-success';

            // Create card body
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';

            // Add pest sign and recommendation
            const pestSign = document.createElement('h5');
            pestSign.className = 'card-title text-success';
            pestSign.innerText = alert.pest_sign;
            cardBody.appendChild(pestSign);

            const recommendation = document.createElement('p');
            recommendation.className = 'card-text';
            recommendation.innerText = alert.recommendation;
            cardBody.appendChild(recommendation);

            // Add image if available
            if (alert.image) {
                const img = document.createElement('img');
                img.src = `data:image/jpeg;base64,${alert.image}`;
                img.alt = alert.pest_sign;
                img.className = 'card-img-top mb-2';

                cardBody.insertBefore(img, cardBody.firstChild);
            }

            // Append card body to card
            alertDiv.appendChild(cardBody);

            // Append to container
            container.appendChild(alertDiv);
        });

        // Update pagination buttons
        prevButton.disabled = currentPage === 1;
        nextButton.disabled = endIndex >= notifications.length;
        pageInfo.innerText = `Page ${currentPage}`;
    }

    // Event listeners for pagination buttons
    document.getElementById('prev-page').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderNotifications();
        }
    });

    document.getElementById('next-page').addEventListener('click', () => {
        if (currentPage * notificationsPerPage < notifications.length) {
            currentPage++;
            renderNotifications();
        }
    });

    // Load notifications on page load
    window.onload = loadNotifications;
</script>
{% endblock content %}
